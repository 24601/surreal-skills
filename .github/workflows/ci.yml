name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Skill
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Validate SKILL.md frontmatter
        run: |
          echo "Checking SKILL.md exists and has frontmatter..."
          if [ ! -f SKILL.md ]; then
            echo "ERROR: SKILL.md not found"
            exit 1
          fi
          head -1 SKILL.md | grep -q "^---" || { echo "ERROR: SKILL.md missing frontmatter delimiter"; exit 1; }
          grep -q "^name:" SKILL.md || { echo "ERROR: SKILL.md missing 'name' field"; exit 1; }
          grep -q "^description:" SKILL.md || { echo "ERROR: SKILL.md missing 'description' field"; exit 1; }
          echo "SKILL.md frontmatter is valid."

      - name: Python syntax check
        run: |
          echo "Checking Python script syntax..."
          for script in scripts/*.py; do
            echo "  Checking $script"
            python3 -m py_compile "$script"
          done
          echo "All Python scripts compile successfully."

      - name: Smoke test onboard script
        run: |
          uv run scripts/onboard.py --help

      - name: Verify rule files exist
        run: |
          echo "Checking required rule files..."
          expected_rules=(
            "rules/surrealql.md"
            "rules/data-modeling.md"
            "rules/graph-queries.md"
            "rules/vector-search.md"
            "rules/security.md"
            "rules/performance.md"
            "rules/sdks.md"
            "rules/deployment.md"
            "rules/surrealism.md"
            "rules/surreal-sync.md"
            "rules/surrealist.md"
            "rules/surrealfs.md"
          )
          missing=0
          for rule in "${expected_rules[@]}"; do
            if [ ! -f "$rule" ]; then
              echo "  MISSING: $rule"
              missing=$((missing + 1))
            else
              echo "  OK: $rule"
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing rule file(s) missing"
            exit 1
          fi
          echo "All rule files present."

      - name: Verify community files
        run: |
          echo "Checking community files..."
          for file in CHANGELOG.md CONTRIBUTING.md LICENSE SECURITY.md; do
            if [ ! -f "$file" ]; then
              echo "  MISSING: $file"
              exit 1
            else
              echo "  OK: $file"
            fi
          done
          echo "All community files present."

      - name: Validate sub-skill manifests
        run: |
          echo "Checking sub-skill SKILL.md files..."
          for subskill in skills/*/SKILL.md; do
            echo "  Checking $subskill"
            head -1 "$subskill" | grep -q "^---" || { echo "ERROR: $subskill missing frontmatter"; exit 1; }
          done
          echo "All sub-skill manifests valid."
